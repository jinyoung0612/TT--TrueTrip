<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Yoga Studio Template">
    <meta name="keywords" content="Yoga, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>TT-TrueTrip</title>

    <!-- Google Font -->


    <!-- Css Styles -->

    <link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/css/flaticon.css" type="text/css">
    <link rel="stylesheet" href="/css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="/css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="/css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="/css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <style type ="text/css">
        a {
            /*color: #007bff;*/
            color: #6699f2;
        }
        a:hover{
            color: #007bff;
            text-decoration: underline;
        }
        h1{
            margin-top: 28px;
            /*margin-bottom: 30px;*/
            color: white;
        }
        h2 {
            font-weight: 200;
        }
        .BigBox{
            width:70%;
            min-height:200px;
            border: solid #CACDD6 2px;
            alignment: center;
            margin:auto;
            postion: absolute;
        }

        .smallBox{
            width: 95%;
            height:150px;
            border: solid #CACDD6 2px;
            alignment: center;
            margin: auto;
            margin-top: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .smallBox .left{
            width: 20%;
            height: 140px;
            /*border: solid black 1px;*/
            float: left;
            margin-left:10px;
            margin-right:5px;
            margin-top: 3px;
            margin-bottom: 3px;
            text-align: center;
        }
        .smallBox .left .item{
            background: #FF5581;
            margin: 30px;
            color: #FFF;
            -webkit-border-radius: 3px;
            -moz-border-radius: 3px;
            border-radius: 3px;
            text-align: center;
            vertical-align: middle;
        }

        .smallBox .middle{
            width: 54%;
            height: 140px;
            /*border: solid black 1px;*/
            float: left;
            margin-left: 5px;
            margin-right: 5px;
            margin-top: 3px;
            margin-bottom: 3px;
            text-align: left;
            padding: 10px;
        }

        .smallBox .middle .item{
            text-align: left;
            margin-left: 30px;
            font-size: 20px;
            margin-bottom: 11px;
        }

        .smallBox .right{
            width: 20%;
            height: 140px;
            /*border: solid black 1px;*/
            float: left;
            margin-left:5px;
            margin-right:10px;
            margin-top: 3px;
            margin-bottom: 3px;
            text-align: left;
        }

        .smallBox .right .item{
            text-align: center;
            font-size: 30px;
        }



    </style>
</head>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script>

<% if(data_length!=0) { %>
    $(document).ready(function(){


        var data="<%=send_data[0]._id%>";
        var data_length="<%=data_length%>";
        var req_ids=new Array();


        <% for(var i=0; i<data_length; i++) { %>
        var postid="<%=send_data[i].selectpost%>";
        var array=postid.split(",");
        var post_len=array.length;

        var request_id="<%=send_data[i]._id%>";
        var req_array=request_id.split(",");
        console.log(req_array);

        req_ids.push(req_array);
        var postsArr="";
        console.log("길이"+post_len);
        var str="";
        var test= new Array();

        //선택장소 보여줌
        for(var j=0; j<post_len;j++){

            console.log("array:"+array[j]);

            $.ajax({
                url:'/findTitle',
                dataType: 'json',
                type:'Post',
                data:{"postid":array[j]},
                async:false,
                success: function(post_title) {
                    if(post_title){
                        // alert(result.result);
                        console.log(post_title.post_title);
                        console.log("성공");
                        console.log(data_length);
                        test.push(post_title.post_title);
                        console.log(test);
                        var iii="<%=i%>"

                        str= "선택장소: "+test

                        for(var k=0; k<post_len;k++){
                            $("#"+iii).children(".middle").children().children("div[name=reservePlace]").html(str);
                        }

                    }
                },
                error: function(request,status,error){
                    alert(error);
                }

            })

        }

        <% } %>

        for(var i=0; i<data_length;i++){
            $.ajax({
                url:'/findConfirm',
                dataType: 'json',
                type:'Post',
                data:{"reqid":req_ids[i]},
                async:false,
                success: function(data) {
                    if(data.data==null){
                        console.log("계획 미작성");
                    }
                    else{
                        console.log("계획 작성 완료");
                        var string="";
                        string+=
                        "<div>" +
                        "  계획 작성완료 " +
                        "                     </div>"

                        $("#"+i).children(".right").children(".item1").html(string);


                        $.ajax({
                            url:'/reviewState',
                            dataType: 'json',
                            type:'Post',
                            data:{"reqid":req_ids[i]},
                            async:false,
                            success: function(data) {
                                console.log(data);
                                if(data.data==true){
                                    var string="";
                                    string +=
                                        "<div>" +
                                        "                                    <a href=\"/mypage\">"+"리뷰 보러가기"+"</a>" +
                                        "</div>"
                                    $("#"+i).children(".right").children(".item2").html(string);
                                    console.log("리뷰 작성완료");
                                }
                                else{
                                    console.log("리뷰 작성없음");
                                    $("#"+i).children(".right").children(".item2").html("리뷰 기다리는중");
                                }

                            },
                            error: function(request,status,error){
                                alert(error);
                            }

                        })

                    }
                },
                error: function(request,status,error){
                    alert(error);
                }

            })

        }



        //plan.js post /sendReqID로 감
        $("a[name=accept]").click(function(){

            var id_num= $(this).parent().parent().parent().attr('id');
            id_num=id_num*1;
            console.log(req_ids[id_num]);


            var send=$.post('/sendReqID', {
                'req_id':req_ids[id_num]
            });

        })

        //request.js /reject로 감
        $("a[name=reject]").click(function(){
            //
            var select_num= $(this).parent().parent().parent().attr('id');
            select_num=select_num*1;

            console.log(req_ids[select_num]);
            console.log(typeof(req_ids[select_num]));
            $.ajax({
                url:'/reject',
                dataType: 'json',
                type:'Post',
                data:{"data":req_ids[select_num]},
                success: function(result) {
                    if(result){
                        // alert(result.result);
                       console.log("성공");
                    }
            },
                error: function(request,status,error){
                    alert(error);
                }

            })
        })

    })
<% } %>

</script>
<body>

<!-- Page Preloder -->
<div id="preloder">
    <div class="loader"></div>
</div>

<!-- Header Section Begin -->
<header class="header-section listings">
    <% if(isAuthenticated) { %>
        <% include header_af_login.ejs %>
    <% } else { %>
        <% include header_bf_login.html %>
    <% } %>
</header>
<!-- Header End -->


<!-- Contact Section Begin -->
<section class="contact-section spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">

                <!--                    나의 요청. -->
                <br><br><br>

                <div class="BigBox" id="receivedQuest">
                    <h2 style="margin-left: 6px;"><b>나에게 온 플랜 요청</b></h2><hr style="margin-top: 0px; margin-bottom: 0px;">
                    <% if ( data_length==0) {  %>
                        <h5>요청이 없습니다.</h5>
                    <% } else { %>
                    <% for(var i=0; i<data_length; i++) { %>
                        <% if( send_data[i].confirm==false) { %> 
			<div class="smallBox" id="<%=i%>">
                            <div class="left">
                                <div class="item"><h1><%=i+1%></h1></div>
                            </div>

                            <div class="middle">
                                <a>
                                    <div class="item" name="reservePlanner">"<%= send_data[i].author%>" 님의 플랜 요청입니다.</div>
<!--                                    <br>-->
                                    <div class="item"name="reserveDate">여행날짜: <%= send_data[i].date %></div>
<!--                                    <br>-->
                                    <div class="item" name="reservePlace"></div>
<!--                                    <br>-->
                                    <div class="item" name="select_request" style="display:none"><%= send_data[i]._id%></div>
                                </a>
                            </div>
                            <div id="test"></div>
                            <div class="right">
                                <div class="item"><a style="color: #f22a05">거절완료</a></div><br>
                            </div>
                        </div>
                        <% } else { %>

                    <div class="smallBox" id="<%=i%>">
                        <div class="left">
                            <div class="item"><h1><%=i+1%></h1></div>
                        </div>

                        <div class="middle">
                            <a>
                                <div class="item" name="reservePlanner">"<%= send_data[i].author%>" 님의 플랜 요청입니다.</div>
<!--                                <br>-->
                                <div class="item"name="reserveDate">여행날짜: <%= send_data[i].date %></div>
<!--                                <br>-->
                                <div class="item" name="reservePlace">선택장소: </div>
<!--                                <br>-->
                                <div class="item" name="select_request" style="display:none"><%= send_data[i]._id%></div>
                            </a>
                        </div>
                        <div id="test"></div>
                        <div class="right">
                            <div class="item1"><a name="accept" href="/sendReqID"><img src="/img/icon/o.jpg" width="16" height="16">요청수락</a></div><br>
                            <div class="item2"><a name="reject"href=""><img src="/img/icon/x.png" width="16" height="16">요청거부</a></div><br>
                        </div>
                    </div>
                    <% } %>
                    <% } %>
                    <% } %>

                </div>
                <br>

                <p id="result"></p>

<!--                <div class="BigBox" id="acceptedQuest">-->
<!--                    <h2 style="margin-left: 6px;"><b>채택된 플랜</b></h2><hr style="margin-top: 0px; margin-bottom: 0px;">-->

<!--                    <div class="smallBox">-->
<!--                        <div class="left">-->
<!--                            <div class="item"><h1>1</h1></div>-->
<!--                        </div>-->

<!--                        <div class="middle">-->
<!--                            <a href="">-->
<!--                                <div class="item" id="reservePlanner">여행자 이름: OOO</div>-->
<!--&lt;!&ndash;                                <br>&ndash;&gt;-->
<!--                                <div class="item" id="reserveDate">날짜: 2019.00.00</div>-->
<!--&lt;!&ndash;                                <br>&ndash;&gt;-->
<!--                                <div class="item" id="reservePlace">선택장소: A, B</div>-->
<!--                            </a>-->
<!--                        </div>-->

<!--                        <div class="right">-->
<!--                            <div class="item">만족도<br>10 / 10</div><br>-->
<!--                        </div>-->
<!--                    </div>-->

<!--                </div>-->
<!--                <div class="row" id="showRequest"></div>-->


            </div>
        </div>
    </div>
</section>
<!-- Contact Section End -->


<!-- Js Plugins -->
<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/jquery.slicknav.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/jquery.nice-select.min.js"></script>
<script src="/js/mixitup.min.js"></script>
<script src="/js/main.js"></script>
</body>

</html>
